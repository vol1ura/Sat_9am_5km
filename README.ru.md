# Sat 9am 5km - система для беговых событий

Это веб-приложение для организации и управления беговыми событиями Оно позволяет атлетам регистрироваться на забеги отслеживать свои результаты получать награды и взаимодействовать с другими участниками

## Установка и запуск

### Требования

- Docker
- Docker Compose

### Инструкции

1.  **Склонируйте репозиторий**

    ```bash
    git clone https://github.com/vol1ura/Sat_9am_5km.git
    cd Sat_9am_5km
    ```

2.  **Создайте файлы конфигурации**

    Скопируйте файлы с примерами конфигурации

    ```bash
    cp ./deploy/.env.example ./deploy/.env
    cp ./config/database.yml.example ./config/database.yml
    ```

    При необходимости отредактируйте `deploy/.env` и `config/database.yml` в соответствии с вашими настройками

3.  **Соберите и запустите приложение**

    Используйте `make` для сборки и запуска Docker-контейнеров

    ```bash
    make build
    make
    ```

4.  **Подготовка базы данных**

    Войдите в контейнер
    ```bash
    make ash
    ```

    Внутри контейнера выполните следующие команды для подготовки базы данных

    ```bash
    rails db:prepare
    rake db:parse_parkrun_codes[kuzminki_db.csv]
    ```

5.  **Доступ к приложению**

    -   **Сайт** http://localhost:3000
    -   **Админ-панель** http://localhost:3000/admin
    -   **Просмотр писем** http://localhost:3000/rails/mailers
    -   **Панель базы данных** http://localhost:3003/?pgsql=db&username=postgres

## Структура приложения

Проект разработан на Ruby on Rails и следует стандартной структуре Rails-приложений

-   `app/` Основная логика приложения
    -   `controllers/` Контроллеры обрабатывающие HTTP-запросы
    -   `models/` Модели данных представляющие таблицы в базе данных
    -   `views/` Шаблоны для отображения страниц
    -   `jobs/` Фоновые задачи используется Sidekiq
    -   `services/` Сервисные объекты для бизнес-логики
-   `config/` Файлы конфигурации
-   `db/` Схема и миграции базы данных
-   `spec/` Тесты RSpec

## Основные возможности

-   **События** Создание и управление беговыми событиями
-   **Атлеты** Профили атлетов с их результатами и статистикой
-   **Результаты** Загрузка и обработка результатов забегов
-   **Награды** Автоматическое присвоение наград за достижения
-   **Клубы** Возможность объединения атлетов в клубы
-   **Волонтерство** Учет волонтеров и их ролей на событиях
-   **Админ-панель** Интерфейс для управления всеми аспектами приложения

## Модели данных

Ниже представлено описание основных моделей данных и их взаимосвязей

-   **`User`** Пользователь Представляет пользователя системы Может быть связан с профилем атлета Содержит информацию для аутентификации и личные данные

-   **`Athlete`** Атлет Основная сущность представляющая участника забегов
    -   Связан с `User` один к одному
    -   Может принадлежать к `Club`
    -   Имеет множество `Result` результатов
    -   Имеет множество `Trophy` наград
    -   Может дружить с другими атлетами `Friendship`

-   **`Event`** Событие Представляет локацию или организацию проводящую забеги например Парк Горького
    -   Имеет множество `Activity` забегов
    -   Имеет множество `VolunteeringPosition` волонтерских позиций

-   **`Activity`** Забег Конкретный забег проведенный в определенную дату в рамках `Event`
    -   Принадлежит к `Event`
    -   Имеет множество `Result` результатов
    -   Имеет множество `Volunteer` волонтеров

-   **`Result`** Результат Результат участия атлета в забеге
    -   Принадлежит к `Activity`
    -   Принадлежит к `Athlete`
    -   Содержит время позицию и другую информацию

-   **`Club`** Клуб Объединение атлетов
    -   Имеет множество `Athlete`

-   **`Badge`** Награда Тип награды которую можно получить за определенные достижения например 50 забегов

-   **`Trophy`** Трофей Экземпляр `Badge` выданный конкретному `Athlete`

-   **`Volunteer`** Волонтер Атлет который помогает в организации забега
    -   Принадлежит к `Activity`
    -   Принадлежит к `Athlete`
    -   Имеет `role` роль например сканирование штрих-кодов

## Фоновые задачи

Приложение использует Sidekiq для выполнения фоновых задач Это позволяет выполнять длительные операции не блокируя основной поток приложения

Основные фоновые задачи

-   **`AthletePersonalBestsUpdateJob`** Обновляет личные рекорды атлета
-   **`AthleteStatsUpdateJob`** Обновляет статистику атлета количество забегов волонтерств и тд
-   **`AthletesAwardingJob`** Присваивает награды атлетам за различные достижения
-   **`ResultsProcessingJob`** Обрабатывает загруженные результаты забегов
-   **`ScannerProcessingJob`** **`TimerProcessingJob`** Обрабатывают данные со сканеров и таймеров
-   **`EventAthletesCsvExportJob`** Экспортирует список участников события в CSV файл
-   **`CompressUserImageJob`** Сжимает изображения загруженные пользователями
-   **`RenewGoingToEventJob`** Обновляет информацию о том кто собирается на событие
-   Различные задачи для присвоения наград `BreakingTimeAwardingJob` `FivePlusAwardingJob` и тд

## API

Приложение предоставляет JSON API для интеграции с другими сервисами и мобильными приложениями
API разделено на несколько контекстов

### Internal API

-   **`api/internal/athletes`**: для внутренних операций с атлетами
-   **`api/internal/users`**: для внутренних операций с пользователями

### Mobile API

-   **`api/mobile/activities`**: для получения информации о забегах
-   **`api/mobile/athletes`**: для получения информации об атлетах

### Parkzhrun API

-   **`api/parkzhrun/activities`**: для интеграции с сервисом Parkzhrun (забеги)
-   **`api/parkzhrun/athletes`**: для интеграции с сервисом Parkzhrun (атлеты)

## Сервисы

Приложение использует сервисные объекты для инкапсуляции сложной бизнес-логики

Основные сервисы:

-   **`ScannerParser`** и **`TimerParser`**: Парсят данные полученные со сканера и таймера
-   **`BarcodePrinter`**: Генерирует и печатает штрих-коды для атлетов
-   **`VkPhotos`**: Взаимодействует с API ВКонтакте для получения фотографий
-   **`Telegram::*`**: Сервисы для работы с Telegram ботом
-   **`Athletes::*`**: Набор сервисов для выполнения операций над атлетами (например `Athletes::Merging`)
-   **`Users::*`**: Набор сервисов для операций над пользователями
-   **`ClearCache`**: Очищает кеш приложения

## Тестирование

Проект покрыт тестами с использованием RSpec
Тесты находятся в директории `spec`

Для запуска тестов выполните команду:

```bash
rspec
```