# Архитектура приложения

## Обзор

Sat 9am 5km — это веб-приложение на Ruby on Rails 8.0, построенное по принципам MVC (Model-View-Controller) с использованием сервисных объектов.

## Архитектурные слои

### 1. Модели (Models)


#### Основные модели

**User** — пользователи системы
- Аутентификация через Devise
- Связь один-к-одному с Athlete
- Роли: super_admin, admin, обычный пользователь
- Поддержка Telegram авторизации

**Athlete** — спортсмены (участники забегов)
- Связь с User (опционально)
- Поддержка различных систем кодирования (parkrun, parkzhrun, fiveverst, runpark)
- Статистика и личные рекорды
- Связи с клубами, событиями, результатами

**Event** — события (забеги)
- Принадлежность к стране
- Часовой пояс
- Активность (включен/выключен)
- Связи с активностями, атлетами, контактами

**Activity** — конкретные активности (забег в определенную дату)
- Принадлежность к Event
- Дата проведения
- Статус публикации
- Токен для мобильного приложения
- Связи с результатами и волонтёрами

**Result** — результаты участников
- Принадлежность к Activity и Athlete
- Позиция финиша
- Время (total_time)
- Флаги: personal_best, first_run

**Volunteer** — волонтёры
- Принадлежность к Activity и Athlete
- Роль (director, timer, scanner, etc.)
- Комментарий

**Badge** — знаки отличия
- Тип (participating, funrun, breaking_time, etc.)
- Информация в JSON формате
- Изображение (Active Storage)

**Trophy** — награды спортсменов
- Связь Athlete и Badge
- Дата получения

**Club** — клубы
- Название и описание
- Связь с атлетами

**Friendship** — дружеские связи
- Связь между двумя атлетами
- Односторонняя дружба

### 2. Контроллеры (Controllers)

Контроллеры обрабатывают HTTP запросы и координируют взаимодействие между моделями и представлениями.

#### Основные контроллеры

- **PagesController** — статические страницы
- **EventsController** — управление событиями
- **ActivitiesController** — управление активностями
- **AthletesController** — профили спортсменов
- **ResultsController** — результаты забегов
- **VolunteersController** — управление волонтёрами
- **BadgesController** — просмотр бейджей
- **ClubsController** — клубы
- **RatingsController** — рейтинги
- **DuelsController** — дуэли между атлетами

#### API контроллеры

- **API::Internal** — внутренний API (только localhost)
- **API::Mobile** — мобильный API для волонтёров
- **API::Parkzhrun** — API для интеграции с Parkzhrun

### 3. Представления (Views)

Представления используют ERB шаблоны и Bootstrap 5 для UI.

#### Основные компоненты

- **Layouts** — базовые шаблоны (application, home)
- **Partials** — переиспользуемые компоненты
- **JavaScript** — Stimulus контроллеры для интерактивности

### 4. Сервисы (Services)

Сервисные объекты инкапсулируют бизнес-логику, которая не относится напрямую к моделям.

#### Основные сервисы

**Athletes::**
- `Finder` — поиск атлетов по коду
- `DuelsService` — логика дуэлей
- `StatsUpdate` — обновление статистики
- `TimePredictor` — предсказание времени
- `DuplicatesFinder` — поиск дубликатов
- `Reuniter` — объединение дубликатов

**Users::**
- `AuthToken` — генерация токенов авторизации
- `ImageCompressor` — сжатие изображений

**Telegram::**
- `Bot` — работа с Telegram ботом
- `Notification::*` — различные типы уведомлений

**Parkzhrun::**
- `Client` — клиент для работы с Parkzhrun API
- `ActivityCreator` — создание активностей
- `AthleteFinder` — поиск атлетов

**Прочие:**
- `BarcodePrinter` — генерация штрих-кодов
- `ScannerParser` — парсинг данных сканера
- `TimerParser` — парсинг данных таймера
- `ClearCache` — очистка кэша
- `VkPhotos` — работа с фотографиями VK

### 5. Фоновые задачи (Jobs)

ActiveJob используется для асинхронной обработки задач через Sidekiq.

#### Основные задачи

**Обработка результатов:**
- `ResultsProcessingJob` — обработка результатов забега
- `TimerProcessingJob` — обработка данных с таймера
- `ScannerProcessingJob` — обработка данных со сканера

**Награждение:**
- `AthletesAwardingJob` — награждение спортсменов
- `BreakingTimeAwardingJob` — награждение за улучшение времени
- `FivePlusAwardingJob` — награждение за участие 5+ недель
- `HomeBadgeAwardingJob` — награждение домашним бейджем
- `MinuteBingoAwardingJob` — награждение "минутным бинго"
- `FullProfileAwardingJob` — награждение за полный профиль
- `FunrunAwardingJob` — награждение за funrun

**Обновление данных:**
- `AthleteStatsUpdateJob` — обновление статистики
- `AthletePersonalBestsUpdateJob` — обновление личных рекордов
- `RenewGoingToEventJob` — обновление списков участников

**Уведомления:**
- `Telegram::Notification::*` — различные Telegram уведомления

**Прочие:**
- `CompressUserImageJob` — сжатие изображений пользователей
- `EventAthletesCsvExportJob` — экспорт данных в CSV

### 6. Административная панель

ActiveAdmin используется для административного интерфейса.

#### Основные ресурсы

- Activities
- Athletes
- Badges
- Clubs
- Contacts
- Dashboard
- Events
- Newsletters
- Permissions
- Results
- Trophies
- Users
- Utilities
- Volunteering Positions
- Volunteers

## Паттерны проектирования

### Service Objects

Бизнес-логика вынесена в сервисные объекты для улучшения тестируемости и переиспользования.

Пример:
```ruby
class Athletes::Finder
  def self.call(personal_code)
    # логика поиска
  end
end
```

### Query Objects

Сложные запросы к базе данных инкапсулированы в scope методы моделей.

### Form Objects

Сложные формы используют вложенные атрибуты (nested attributes) или отдельные объекты.

### Policy Objects

Авторизация реализована через CanCanCan с использованием модели Ability.

## База данных

### PostgreSQL

- Версия: 17.2
- Расширения:
  - `pg_stat_statements` — статистика запросов
  - `pg_trgm` — триграммы для полнотекстового поиска

### Индексы

- Индексы на внешние ключи
- Индексы на часто используемые поля (name, codes)
- GIST индексы для полнотекстового поиска
- Уникальные индексы на коды атлетов

### JSON поля

- `athletes.stats` — статистика атлета
- `athletes.personal_bests` — личные рекорды
- `badges.info` — дополнительная информация о бейдже
- `events.live_results` — живые результаты

## Кэширование

### Redis

Используется для:
- Кэширования страниц и фрагментов
- Хранения сессий
- Очередей Sidekiq

### Memcached (Dalli)

Используется для кэширования через Dalli gem.

## Очереди задач

### Sidekiq

Асинхронная обработка задач через Sidekiq с Redis в качестве брокера.

Конфигурация: `config/sidekiq.yml`

## Планировщик задач

### Whenever

Планирование задач через cron. Конфигурация: `config/schedule.rb`

## Файловое хранилище

### Active Storage

Используется для хранения:
- Изображений бейджей
- Аватаров пользователей
- Других файлов

Конфигурация: `config/storage.yml`

В production используется локальное хранилище, но можно настроить S3 или другие провайдеры.

## Безопасность

### Аутентификация

- Devise для аутентификации пользователей
- Поддержка Telegram OAuth
- Токены авторизации для внутренних сервисов

### Авторизация

- CanCanCan для управления правами доступа
- Роли: super_admin, admin, обычный пользователь
- Разрешения на уровне ресурсов

### Защита

- CSRF защита
- Rack::Attack для rate limiting
- Валидация входных данных
- Аудит изменений через Audited

## Производительность

### Оптимизация запросов

- Eager loading (includes, preload, eager_load)
- Индексы на часто используемые поля
- Кэширование запросов

### Мониторинг

- Rails Performance для мониторинга производительности
- PgHero для анализа запросов PostgreSQL
- Rollbar для отслеживания ошибок

## Масштабирование

### Горизонтальное масштабирование

- Stateless приложение (сессии в Redis)
- Несколько экземпляров Puma
- Балансировка нагрузки через Nginx

### Вертикальное масштабирование

- Оптимизация запросов к БД
- Кэширование
- Асинхронная обработка задач

## Интеграции

### Telegram

- Бот для уведомлений
- OAuth авторизация
- Уведомления о результатах, бейджах и событиях

### Parkzhrun

- Синхронизация данных через API
- Импорт результатов
- Импорт атлетов

### Email

- ActionMailer для отправки писем
- SMTP настройки в credentials
- Превью писем в development

## Тестирование

### RSpec

- Модели: `spec/models/`
- Контроллеры: `spec/requests/`
- Сервисы: `spec/services/`
- Jobs: `spec/jobs/`
- Mailers: `spec/mailers/`

### Фабрики

FactoryBot для создания тестовых данных: `spec/factories/`

### Покрытие кода

SimpleCov для отслеживания покрытия кода.

## Развертывание

### Capistrano

Автоматическое развертывание через Capistrano.

### Docker

Контейнеризация для разработки и production.

### Systemd

Управление процессами через systemd (Puma, Sidekiq).

## Локализация

### I18n

Поддержка трёх языков:
- Русский (ru) — основной
- Сербский (rs)
- Английский (en)

Файлы локализации: `config/locales/`

### JSON Translate

Многоязычные поля в JSON формате для некоторых моделей.

