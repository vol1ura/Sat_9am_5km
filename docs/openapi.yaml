openapi: 3.0.3
info:
  title: ParkZhRun Platform API
  version: 1.0.0
  description: |
    REST API surface extracted from the ParkZhRun Rails application. The project serves three distinct
    audiences:

      • **Internal** – maintenance endpoints that run on the same host (loopback `127.0.0.1` only).
      • **ParkZhRun** – machine-to-machine integration protected by a static Authorization header.
      • **Mobile** – endpoints consumed by timing/scanner mobile apps.

    The schemas mirror the persisted data model defined in `db/schema.rb`, while the paths reflect the
    controllers under `app/controllers/api`.
servers:
  - url: https://s95.example.com
    description: Production tenant (replace host with the country-specific domain, e.g. `s95.ru`)
  - url: http://localhost:3000
    description: Local development
tags:
  - name: Internal
    description: Loopback-only endpoints used by back-office automation.
  - name: ParkZhRun
    description: Partner integration secured by a shared Authorization token.
  - name: Mobile
    description: Endpoints consumed by mobile stopwatch, scanner, and volunteer apps.
paths:
  /api/internal/user:
    post:
      tags: [Internal]
      operationId: createInternalUser
      summary: Create a platform user and optionally link or create an athlete
      description: |
        Wraps `API::Internal::UsersController#create`. The request must originate from the loopback
        interface (`127.0.0.1`), otherwise a 403 is returned. When `athlete_id` is omitted, the payload under
        `athlete` is used to create and attach a brand-new athlete record; otherwise the existing athlete is
        linked.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InternalUserCreateRequest'
      responses:
        '201':
          description: User created and confirmed; response body is empty.
        '403':
          $ref: '#/components/responses/ForbiddenLoopback'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
  /api/internal/user/auth_link:
    post:
      tags: [Internal]
      operationId: generateAuthLink
      summary: Generate a one-time authentication link for an existing user
      description: |
        Wraps `API::Internal::UsersController#auth_link`. Requires loopback access. The `domain` is used to
        build the subdomain (`s95.<domain>`).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InternalUserAuthLinkRequest'
      responses:
        '200':
          description: Authentication link issued.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthLinkResponse'
        '403':
          $ref: '#/components/responses/ForbiddenLoopback'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/internal/athlete:
    put: &internalAthleteUpdate
      tags: [Internal]
      operationId: updateInternalAthlete
      summary: Update club/home-event for an athlete by Telegram id
      description: |
        Wraps `API::Internal::AthletesController#update`. The controller searches for an athlete that belongs
        to a user with the supplied `telegram_id`. Only loopback callers are accepted.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InternalAthleteUpdateRequest'
      responses:
        '200':
          description: Athlete updated; response body is empty.
        '403':
          $ref: '#/components/responses/ForbiddenLoopback'
        '404':
          $ref: '#/components/responses/NotFound'
        '406':
          description: Invalid club or event id (foreign key constraint breached).
        '422':
          $ref: '#/components/responses/ValidationError'
    patch:
      <<: *internalAthleteUpdate
      operationId: patchInternalAthlete
  /api/parkzhrun/activities:
    post:
      tags: [ParkZhRun]
      operationId: createParkzhrunActivity
      summary: Trigger creation of an activity for a given date
      description: |
        Wraps `API::Parkzhrun::ActivitiesController#create`. Requires the shared secret in the
        `Authorization` header. On success an asynchronous workflow generates activity data; errors are
        reported to Rollbar and surfaced as a 422.
      security:
        - ParkzhrunToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParkzhrunActivityCreateRequest'
      responses:
        '201':
          description: Activity creation scheduled; response body is empty.
        '401':
          $ref: '#/components/responses/UnauthorizedToken'
        '422':
          $ref: '#/components/responses/SimpleError422'
  /api/parkzhrun/athletes/{id}:
    parameters:
      - $ref: '#/components/parameters/ParkzhrunAthleteId'
    put: &parkzhrunAthleteUpdate
      tags: [ParkZhRun]
      operationId: updateParkzhrunAthlete
      summary: Synchronize an athlete profile from the ParkZhRun registry
      description: |
        Wraps `API::Parkzhrun::AthletesController#update`. The `{id}` in the path is the
        `parkzhrun_code`. Optional `parkrun_id` / `five_verst_id` values are only applied when still unique.
      security:
        - ParkzhrunToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParkzhrunAthleteUpsert'
      responses:
        '200':
          description: Athlete updated; response body is empty.
        '401':
          $ref: '#/components/responses/UnauthorizedToken'
        '404':
          $ref: '#/components/responses/ParkzhrunNotFound'
        '422':
          $ref: '#/components/responses/ParkzhrunInvalid'
    patch:
      <<: *parkzhrunAthleteUpdate
      operationId: patchParkzhrunAthlete
  /api/mobile/athletes/{code}/info:
    parameters:
      - $ref: '#/components/parameters/AthletePersonalCode'
      - $ref: '#/components/parameters/Locale'
    get:
      tags: [Mobile]
      operationId: getAthleteInfo
      summary: Fetch volunteer stats and schedule for an athlete
      description: |
        Wraps `API::Mobile::AthletesController#info`. The `{code}` path parameter accepts the personal code
        format used in the mobile apps (see `Athlete::PersonalCode`). Only athletes with a resolvable code
        and positive integer values are accepted.
      responses:
        '200':
          description: Structured volunteer statistics.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AthleteInfoResponse'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/mobile/activities/stopwatch:
    post:
      tags: [Mobile]
      operationId: submitStopwatchResults
      summary: Push raw stopwatch times for an unpublished activity
      description: |
        Wraps `API::Mobile::ActivitiesController#stopwatch`. The activity is resolved by the shared
        `token`, must be unpublished, and the activity date must equal today. Payloads spawn
        `TimerProcessingJob` and notify volunteers subscribed to timer updates.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StopwatchPayload'
      responses:
        '200':
          description: Job accepted; response body is empty.
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          description: Activity is not for today or payload missing; response body is empty.
  /api/mobile/activities/scanner:
    post:
      tags: [Mobile]
      operationId: submitScannerResults
      summary: Push scanner positions for an unpublished activity
      description: |
        Wraps `API::Mobile::ActivitiesController#scanner`. Similar constraints as `/stopwatch`, but the
        payload carries finish tokens and athlete barcodes.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScannerPayload'
      responses:
        '200':
          description: Job accepted; response body is empty.
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          description: Activity is not for today or payload missing; response body is empty.
  /api/mobile/activities/live:
    post:
      tags: [Mobile]
      operationId: submitLiveResults
      summary: Push live ticker data for an activity
      description: |
        Wraps `API::Mobile::ActivitiesController#live`. Requires `results` and `activityStartTime` in the
        request body. Successful requests update the hosting event and broadcast Turbo Stream updates.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LivePayload'
      responses:
        '200':
          description: Live data accepted; response body is empty.
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          description: Missing `results`, activity not for today, or validation failed; response body is empty.
components:
  securitySchemes:
    ParkzhrunToken:
      type: apiKey
      in: header
      name: Authorization
      description: Static token stored in `Rails.application.credentials.parkzhrun_api_key`.
  parameters:
    Locale:
      name: locale
      in: query
      required: false
      schema:
        type: string
        enum: [ru, rs, en]
      description: Force response localization; defaults to `I18n.default_locale`.
    AthletePersonalCode:
      name: code
      in: path
      required: true
      schema:
        type: integer
        format: int64
        minimum: 1
      description: Athlete personal code understood by `Athlete::PersonalCode`.
    ParkzhrunAthleteId:
      name: id
      in: path
      required: true
      schema:
        type: integer
        format: int64
      description: `parkzhrun_code` identifying the athlete in the ParkZhRun registry.
  responses:
    ForbiddenLoopback:
      description: Request did not originate from the loopback interface.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorsMessage'
          example:
            errors: Forbidden
    UnauthorizedToken:
      description: Missing or invalid ParkZhRun Authorization header.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SimpleError'
          example:
            error: Token invalid
    ValidationError:
      description: Request failed model validations.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationErrors'
          example:
            errors:
              user:
                - Email has already been taken
              athlete:
                - Parkrun code has already been taken
    ParkzhrunNotFound:
      description: Athlete with the provided `parkzhrun_code` does not exist.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SimpleError'
          example:
            error: "Couldn't find Athlete with parkzhrun_id='700123456'"
    ParkzhrunInvalid:
      description: Incoming payload failed server-side validations.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SimpleError'
          example:
            error: 'parkzhrun_id has already been taken'
    SimpleError422:
      description: Activity creation failed.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SimpleError'
          example:
            error: "Can't create activity"
    NotFound:
      description: Resource not found or code could not be resolved.
    SimpleError:
      description: Generic error response with a single `error` message.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SimpleError'
  schemas:
    InternalUserCreateRequest:
      type: object
      required: [user]
      properties:
        user:
          $ref: '#/components/schemas/UserUpsert'
        athlete:
          $ref: '#/components/schemas/AthleteUpsert'
        athlete_id:
          type: integer
          format: int64
          description: Existing athlete id to link; omit to create a new athlete.
    UserUpsert:
      type: object
      required: [email, password, first_name, last_name]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        first_name:
          type: string
        last_name:
          type: string
        telegram_id:
          type: integer
          format: int64
          nullable: true
        telegram_user:
          type: string
          nullable: true
    AthleteUpsert:
      type: object
      properties:
        name:
          type: string
        male:
          type: boolean
          nullable: true
        parkrun_code:
          type: integer
          format: int64
          nullable: true
        fiveverst_code:
          type: integer
          format: int64
          nullable: true
        runpark_code:
          type: integer
          format: int64
          nullable: true
    InternalUserAuthLinkRequest:
      type: object
      required: [user_id, domain]
      properties:
        user_id:
          type: integer
          format: int64
        domain:
          type: string
          description: Country domain suffix (`ru`, `rs`, `en`, etc.).
    AuthLinkResponse:
      type: object
      required: [link]
      properties:
        link:
          type: string
          format: uri
          description: Pre-authorized URL pointing to `/user/auth_links/:token`.
    InternalAthleteUpdateRequest:
      type: object
      required: [telegram_id, athlete]
      properties:
        telegram_id:
          type: integer
          format: int64
          description: Telegram id stored on the owning `User`.
        athlete:
          type: object
          properties:
            club_id:
              type: integer
              format: int64
              nullable: true
            event_id:
              type: integer
              format: int64
              nullable: true
    ParkzhrunActivityCreateRequest:
      type: object
      required: [date]
      properties:
        date:
          type: string
          format: date
          description: Activity date to prefill in UTC.
    ParkzhrunAthleteUpsert:
      type: object
      required:
        - athlete
      properties:
        athlete:
          type: object
          properties:
            first_name:
              type: string
            last_name:
              type: string
            patronymic:
              type: string
              nullable: true
            date_of_birth:
              type: string
              format: date
              nullable: true
            gender:
              type: string
              enum: [male, female]
              nullable: true
            city:
              type: string
              nullable: true
            club:
              type: string
              nullable: true
            parkrun_id:
              type: integer
              format: int64
              nullable: true
            five_verst_id:
              type: integer
              format: int64
              nullable: true
    AthleteInfoResponse:
      type: object
      required: [name, male, home_event, volunteering]
      properties:
        name:
          type: string
        male:
          type: boolean
          nullable: true
        home_event:
          type: string
          nullable: true
        volunteering:
          type: object
          required: [stats, scheduled]
          properties:
            stats:
              type: object
              required: [general, history]
              properties:
                general:
                  $ref: '#/components/schemas/VolunteerStats'
                history:
                  $ref: '#/components/schemas/VolunteerHistory'
            scheduled:
              type: array
              items:
                $ref: '#/components/schemas/VolunteerScheduleItem'
    VolunteerStats:
      type: object
      properties:
        count:
          type: integer
          format: int64
        h_index:
          type: integer
        uniq_events:
          type: integer
        trophies:
          type: integer
        longest_streak:
          type: integer
          description: Maximum number of consecutive volunteering weeks.
    VolunteerHistory:
      type: object
      additionalProperties:
        type: array
        minItems: 6
        maxItems: 6
        items:
          type: integer
          minimum: 0
      description: |
        Keys are volunteer role names, values are rolling six-month counts where index 0 represents the
        earliest month and index 5 the current month.
    VolunteerScheduleItem:
      type: object
      required: [event_name, date, role, town]
      properties:
        event_name:
          type: string
        date:
          type: string
          format: date
        role:
          type: string
        town:
          type: string
    StopwatchPayload:
      type: object
      required: [token, results]
      properties:
        token:
          type: string
          description: Shared token assigned to the unpublished activity.
        results:
          type: array
          description: Ordered finish positions with elapsed times (`HH:MM:SS`).
          items:
            $ref: '#/components/schemas/StopwatchResult'
    StopwatchResult:
      type: object
      required: [position, total_time]
      properties:
        position:
          type: integer
          minimum: 1
        total_time:
          type: string
          pattern: '^[0-9]{2}:[0-9]{2}:[0-9]{2}$'
    ScannerPayload:
      type: object
      required: [token, results]
      properties:
        token:
          type: string
        results:
          type: array
          description: Ordered tokens captured by the scanner device.
          items:
            $ref: '#/components/schemas/ScannerResult'
    ScannerResult:
      type: object
      required: [position, code]
      properties:
        position:
          type: string
          description: Finish token identifier (`P1234`, etc.).
        code:
          type: string
          description: Athlete barcode (`A123456`, etc.).
    LivePayload:
      type: object
      required: [token, results, activityStartTime]
      properties:
        token:
          type: string
        results:
          type: array
          description: Partial live leaderboard ordered by position.
          items:
            $ref: '#/components/schemas/LiveResult'
        activityStartTime:
          type: string
          format: date-time
          description: Timestamp reported by the client app.
    LiveResult:
      type: object
      required: [position, total_time]
      properties:
        position:
          type: integer
        total_time:
          type: string
          pattern: '^[0-9]{2}:[0-9]{2}:[0-9]{2}(\\.[0-9]{2})?$'
    ErrorsMessage:
      type: object
      required: [errors]
      properties:
        errors:
          type: string
    SimpleError:
      type: object
      required: [error]
      properties:
        error:
          type: string
    ValidationErrors:
      type: object
      required: [errors]
      properties:
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
          nullable: true
        first_name:
          type: string
        last_name:
          type: string
        role:
          type: string
          enum: [super_admin, admin]
          nullable: true
        telegram_id:
          type: integer
          format: int64
          nullable: true
        telegram_user:
          type: string
          nullable: true
        phone:
          type: string
          nullable: true
        note:
          type: string
          nullable: true
        auth_token:
          type: string
          nullable: true
        auth_token_expires_at:
          type: string
          format: date-time
          nullable: true
        promotions:
          type: array
          items:
            type: string
            enum: [spartacus]
        emergency_contact_name:
          type: string
          nullable: true
        emergency_contact_phone:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Athlete:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
          nullable: true
        parkrun_code:
          type: integer
          format: int64
          nullable: true
        fiveverst_code:
          type: integer
          format: int64
          nullable: true
        parkzhrun_code:
          type: integer
          format: int64
          nullable: true
        runpark_code:
          type: integer
          format: int64
          nullable: true
        male:
          type: boolean
          nullable: true
        user_id:
          type: integer
          format: int64
          nullable: true
        club_id:
          type: integer
          format: int64
          nullable: true
        event_id:
          type: integer
          format: int64
          nullable: true
        going_to_event_id:
          type: integer
          format: int64
          nullable: true
        stats:
          type: object
          properties:
            results:
              $ref: '#/components/schemas/AthleteResultStats'
            volunteers:
              $ref: '#/components/schemas/VolunteerStats'
        personal_bests:
          type: object
          properties:
            "10k":
              type: string
              nullable: true
            half_marathon:
              type: string
              nullable: true
            marathon:
              type: string
              nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    AthleteResultStats:
      type: object
      properties:
        count:
          type: integer
        h_index:
          type: integer
        uniq_events:
          type: integer
        trophies:
          type: integer
        longest_streak:
          type: integer
    Activity:
      type: object
      properties:
        id:
          type: integer
          format: int64
        date:
          type: string
          format: date
        description:
          type: string
          nullable: true
        published:
          type: boolean
        event_id:
          type: integer
          format: int64
        token:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Event:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code_name:
          type: string
        name:
          type: string
        town:
          type: string
        place:
          type: string
        active:
          type: boolean
        description:
          type: string
          nullable: true
        country_id:
          type: integer
          format: int64
        main_picture_link:
          type: string
          nullable: true
        visible_order:
          type: integer
          nullable: true
        slogan:
          type: string
          nullable: true
        latitude:
          type: number
          format: float
          nullable: true
        longitude:
          type: number
          format: float
          nullable: true
        timezone:
          type: string
        live_results:
          type: object
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Club:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        country_id:
          type: integer
          format: int64
        description:
          type: string
          nullable: true
    Country:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
    Result:
      type: object
      properties:
        id:
          type: integer
          format: int64
        position:
          type: integer
        total_time:
          type: string
          nullable: true
        activity_id:
          type: integer
          format: int64
        athlete_id:
          type: integer
          format: int64
          nullable: true
        personal_best:
          type: boolean
        first_run:
          type: boolean
        informed:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Volunteer:
      type: object
      properties:
        id:
          type: integer
          format: int64
        role:
          type: string
          enum:
            - director
            - marshal
            - timer
            - photograph
            - tokens
            - scanner
            - instructor
            - marking_maker
            - event_closer
            - marking_picker
            - cards_sorter
            - bike_leader
            - pacemaker
            - results_handler
            - equipment_supplier
            - public_relations
            - warm_up
            - other
            - attendant
            - finish_maker
            - volunteer_coordinator
            - food_maker
            - videographer
        activity_id:
          type: integer
          format: int64
        athlete_id:
          type: integer
          format: int64
        informed:
          type: boolean
        comment:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Badge:
      type: object
      properties:
        id:
          type: integer
          format: int64
        kind:
          type: string
          enum:
            - funrun
            - full_profile
            - participating
            - home_participating
            - jubilee_participating
            - tourist
            - breaking
            - rage
            - five_plus
            - minute_bingo
            - record
        received_date:
          type: string
          format: date
          nullable: true
        info:
          type: object
        name_translations:
          type: object
          additionalProperties:
            type: string
        conditions_translations:
          type: object
          additionalProperties:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Trophy:
      type: object
      properties:
        id:
          type: integer
          format: int64
        badge_id:
          type: integer
          format: int64
        athlete_id:
          type: integer
          format: int64
        date:
          type: string
          format: date
          nullable: true
        info:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    VolunteeringPosition:
      type: object
      properties:
        id:
          type: integer
          format: int64
        event_id:
          type: integer
          format: int64
        rank:
          type: integer
        role:
          type: string
          enum:
            - director
            - marshal
            - timer
            - photograph
            - tokens
            - scanner
            - instructor
            - marking_maker
            - event_closer
            - marking_picker
            - cards_sorter
            - bike_leader
            - pacemaker
            - results_handler
            - equipment_supplier
            - public_relations
            - warm_up
            - other
            - attendant
            - finish_maker
            - volunteer_coordinator
            - food_maker
            - videographer
        number:
          type: integer
    Contact:
      type: object
      properties:
        id:
          type: integer
          format: int64
        event_id:
          type: integer
          format: int64
        link:
          type: string
        contact_type:
          type: string
          enum:
            - map_link
            - parking
            - phone
            - tg_channel
            - tg_chat
            - vk
            - zen
            - instagram
            - facebook
            - strava
            - email
    Friendship:
      type: object
      properties:
        id:
          type: integer
          format: int64
        athlete_id:
          type: integer
          format: int64
        friend_id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
