<% current_date = Date.current %>
<nav class="navbar top-navbar bg-primary navbar-dark sticky-top mb-3" aria-label="Primary navigation">
  <div class="container-fluid">
    <%=
      link_to root_path, class: 'navbar-brand' do
        image_tag "/images/logo_hex_#{current_date.saturday? ? 'on' : 'off'}.svg", alt: 'S95', title: 'Sat 9am 5km', height: 70, width: 70
      end
    %>
      <ul class="navbar-nav d-none d-md-flex flex-row gap-3 ms-3 me-auto">
        <li class="nav-item">
          <%= link_to t('.events'), events_path, class: "nav-link #{'active' if params[:controller] == 'events'}" %>
        </li>
        <li class="nav-item dropdown" data-controller="dropdown">
          <%=
            button_tag(
              t('.results'),
              type: 'button',
              class: "nav-link dropdown-toggle #{'active' if %w[activities clubs ratings].include?(params[:controller])}",
              id: 'resultsDropdown',
              'data-bs-toggle' => 'dropdown',
              'aria-expanded' => 'false',
              'data-dropdown-target' => 'toggle',
            )
          %>
          <ul class="dropdown-menu" aria-labelledby="resultsDropdown" data-dropdown-target="menu">
            <li><%= link_to t('.recent_results'), activities_path, class: 'dropdown-item' %></li>
            <li><hr class="dropdown-divider"></li>
            <li><%= link_to t('.club_ratings'), clubs_path, class: 'dropdown-item' %></li>
            <li><%= link_to t('.top_results'), results_ratings_path, class: 'dropdown-item' %></li>
            <li><%= link_to t('.top_athletes'), ratings_path(type: 'results'), class: 'dropdown-item' %></li>
            <li><%= link_to t('.top_volunteers'), ratings_path(type: 'volunteers'), class: 'dropdown-item' %></li>
            <li><%= link_to t('.friends_protocol'), protocol_duels_path, class: 'dropdown-item' %></li>
            <li><%= link_to t('.duels'), duels_path, class: 'dropdown-item' %></li>
            <li><%= link_to t('.badges'), badges_path, class: 'dropdown-item' %></li>
          </ul>
        </li>
        <%= render 'navbars/about_s95', with_icon: false %>
      </ul>

    <div class="d-flex align-items-center gap-2 ms-auto">
      <button type="button" class="btn btn-sm fs-6 p-1 theme-toggle" data-action="theme#toggle" aria-label="Toggle theme">
        <i class="fa-solid fa-sun text-light theme-icon-light"></i>
        <i class="fa-solid fa-moon text-light theme-icon-dark"></i>
      </button>
      <button type="button" class="btn btn-sm fs-6 p-1" data-bs-toggle="modal" data-bs-target="#langModal" aria-label="Select language">
        <i class="fa-solid fa-globe text-light"></i>
      </button>

      <% if user_signed_in? %>
        <div class="dropdown">
          <%= button_tag type: 'button', class: 'nav-link', 'data-bs-toggle' => 'dropdown', 'aria-expanded' => 'false' do %>
            <%= image_tag user_image_path(current_user), class: 'avatar-50 border border-light border-3', alt: current_user.first_name %>
          <% end %>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><%= link_to t('.profile'), athlete_path(current_user.athlete), class: 'dropdown-item' %></li>
            <li><%= link_to t('.settings'), user_path, class: 'dropdown-item' %></li>
            <% if current_user.admin? || current_user.permissions.any? %>
              <li><%= link_to t('.admin_panel'), admin_root_path, class: 'dropdown-item' %></li>
            <% end %>
            <li><hr class="dropdown-divider"></li>
            <li><%= link_to t('.logout'), destroy_user_session_path, class: 'dropdown-item text-danger', 'data-turbo-prefetch' => 'false' %></li>
          </ul>
        </div>
      <% else %>
        <%= link_to new_user_session_path, class: 'btn btn-outline-danger' do %>
          <i class="fa-solid fa-arrow-right-to-bracket me-2"></i><%= t '.login' %>
        <% end %>
      <% end %>

      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
    <div class="offcanvas offcanvas-end text-bg-primary" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
      <div class="offcanvas-header">
        <header class="fs-4 mt-3 offcanvas-title" id="offcanvasNavbarLabel">
          <%= link_to t('.s95'), root_path, class: 'link-light text-decoration-none' %>
        </header>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column justify-content-between">
        <ul class="navbar-nav justify-content-start flex-grow-1 fa-ul pe-3">
          <% if (current_date.month == 12) || (current_date.month == 1 && current_date.day == 1) %>
            <li class="nav-item">
              <%= link_to page_path(page: 'additional-events'), class: "nav-link #{'active' if params[:page] == 'additional-events'}" do %>
                <span class="fa-li"><i class="fa-solid fa-snowman"></i></span><%= t '.1_january' %>
              <% end %>
            </li>
          <% end %>
          <li class="nav-item">
            <%= link_to events_path, class: "nav-link #{'active' if params[:controller] == 'events' && params[:action] == 'index'}" do %>
              <span class="fa-li"><i class="fa-solid fa-map-location-dot"></i></span><%= t '.events' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to activities_path, class: "nav-link #{'active' if params[:controller] == 'activities'}" do %>
              <span class="fa-li"><i class="fa-solid fa-square-poll-horizontal"></i></span><%= t '.recent_results' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to clubs_path, class: "nav-link #{'active' if params[:controller] == 'clubs'}" do %>
              <span class="fa-li"><i class="fa-solid fa-people-group"></i></span><%= t '.club_ratings' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to results_ratings_path, class: "nav-link #{'active' if params[:action] == 'results' && params[:controller] == 'ratings'}" do %>
              <span class="fa-li"><i class="fa-solid fa-trophy"></i></span><%= t '.top_results' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to ratings_path(type: 'results'), class: "nav-link #{'active' if params[:type] == 'results' && params[:controller] == 'ratings'}" do %>
              <span class="fa-li"><i class="fa-solid fa-table"></i></span><%= t '.top_athletes' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to ratings_path(type: 'volunteers'), class: "nav-link #{'active' if params[:type] == 'volunteers' && params[:controller] == 'ratings'}" do %>
              <span class="fa-li"><i class="fa-solid fa-table"></i></span><%= t '.top_volunteers' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to protocol_duels_path, class: "nav-link #{'active' if params[:controller] == 'duels' && params[:action] == 'protocol'}" do %>
              <span class="fa-li"><i class="fa-solid fa-list-ol"></i></span><%= t '.friends_protocol' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to duels_path, class: "nav-link #{'active' if params[:controller] == 'duels' && params[:action].in?(%w[index show])}" do %>
              <span class="fa-li"><i class="fa-solid fa-people-arrows"></i></span><%= t '.duels' %>
            <% end %>
          </li>
          <li class="nav-item">
            <%= link_to badges_path, class: "nav-link #{'active' if params[:controller] == 'badges'}" do %>
              <span class="fa-li"><i class="fa-solid fa-award"></i></span><%= t '.badges' %>
            <% end %>
          </li>
          <%= render 'navbars/about_s95', with_icon: true %>
        </ul>

        <%= form_with url: athletes_path, method: :get, class: 'my-3', role: 'search' do |f| %>
          <div class="input-group">
            <%= f.text_field :q, type: 'search', class: 'form-control', placeholder: t('.name_or_id'), 'aria-label' => 'Search', autocomplete: 'off' %>
            <%= f.submit t('.search'), class: 'btn btn-outline-light' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</nav>

<div class="modal fade" id="langModal" tabindex="-1" aria-hidden="true" aria-labelledby="langModalLabel">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="fs-5 modal-title" id="langModalLabel"><%= t '.language' %></h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="list-group list-group-flush">
          <% [[:en, 'English', 'ðŸ‡¬ðŸ‡§'], [:ru, 'Ð ÑƒÑÑÐºÐ¸Ð¹', 'ðŸ‡·ðŸ‡º'], [:sr, 'Srpski', 'ðŸ‡·ðŸ‡¸']].each do |locale, title, flag| %>
            <% opts = { only_path: true, params: request.query_parameters.except(:lang) } %>
            <% opts[:lang] = (locale == domain_locale ? nil : locale) %>
            <%= link_to opts, class: 'list-group-item d-flex justify-content-between align-items-center' do %>
              <div class="me-auto">
                <span class="me-2"><%= flag %></span>
                <%= title %>
              </div>
              <% if current_locale == locale %>
                <div class="me-2">
                  <i class="fa-solid fa-check text-success"></i>
                </div>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
